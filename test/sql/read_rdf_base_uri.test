# name: test/sql/read_rdf_base_uri.test
# description: Test base_uri parameter for read_rdf
# group: [sql]

require read_rdf

# TC-01: User base provided, no @base in file
# Validates: - user base_uri resolves relative URIs
query II
SELECT subject, object FROM read_rdf('test/rdf/no_base.ttl', base_uri := 'http://test.org/')
ORDER BY subject
----
http://test.org/alice	http://test.org/bob
http://test.org/s	http://test.org/o

# TC-02: User base provided, file has @base - file wins
# Validates: - file @base overrides user base_uri
query I
SELECT subject FROM read_rdf('test/rdf/with_base.ttl', base_uri := 'http://user.org/')
WHERE subject LIKE '%/s'
----
http://file.org/s

# TC-03: No base anywhere - relative URIs stay relative
query I
SELECT subject FROM read_rdf('test/rdf/no_base.ttl')
WHERE subject = 's'
----
s

# TC-04: File has @base, no user base - file base used
query I
SELECT subject FROM read_rdf('test/rdf/with_base.ttl')
WHERE subject LIKE '%/s'
----
http://file.org/s

# TC-05: Empty string base = no base
query I
SELECT subject FROM read_rdf('test/rdf/no_base.ttl', base_uri := '')
WHERE subject = 's'
----
s

# TC-06: Trailing slash behavior - base without trailing slash
# Validates: - W3C URI resolution: base without path gets / added before relative
query I
SELECT subject FROM read_rdf('test/rdf/no_base.ttl', base_uri := 'http://test.org')
WHERE subject LIKE 'http://test.org/%'
ORDER BY subject
LIMIT 1
----
http://test.org/alice

# TC-07: Trailing slash behavior - base with trailing slash
# Validates: - Same result as TC-06 (W3C spec handles both correctly)
query I
SELECT subject FROM read_rdf('test/rdf/no_base.ttl', base_uri := 'http://test.org/')
WHERE subject LIKE 'http://test.org/%'
ORDER BY subject
LIMIT 1
----
http://test.org/alice

# TC-08: Multiple @base directives in file - later one wins
# Validates: - Each @base applies to statements after it
query II
SELECT subject, object FROM read_rdf('test/rdf/multi_base.ttl')
ORDER BY subject
----
http://first.org/first_subject	http://first.org/first_object
http://second.org/second_subject	http://second.org/second_object

# TC-09: User base + multiple @base in file - file bases take precedence
# Validates: - User base used before first @base, file @base used after
query II
SELECT subject, object FROM read_rdf('test/rdf/multi_base.ttl', base_uri := 'http://user.org/')
ORDER BY subject
----
http://first.org/first_subject	http://first.org/first_object
http://second.org/second_subject	http://second.org/second_object

# TC-10: Standard IRI in base_uri
# Validates: - Standard IRIs are handled correctly
query I
SELECT subject FROM read_rdf('test/rdf/unicode_test.ttl', base_uri := 'http://example.org/ontologie/')
WHERE subject LIKE '%entity'
----
http://example.org/ontologie/entity